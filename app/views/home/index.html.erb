<%=render 'partials/zone-time'%>
<section class="py-3">
    <!-- Highlights -->
    <div class="row">
        <div class="col-sm-6 col-xl-3">
            <div class="card mb-5 shadow-sm border-0 shadow-hover">
                <div class="card-body d-flex">
                    <div>
                        <div class="circle rounded-circle bg-primary align-self-center d-flex mr-3">
                            <i class="icon ion-md-trending-up text-primary align-self-center mx-auto lead"></i>
                        </div>
                    </div>
                    <div class="align-self-center">
                        <h6 class="mb-0"><%=@transactions_totales%></h6>
                        <small class="text-muted">Envios realizados</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card mb-5 shadow-sm border-0 shadow-hover">
                <div class="card-body d-flex">
                    <div>
                        <div class="circle rounded-circle bg-primary align-self-center d-flex mr-3">
                            <i class="icon ion-md-people text-primary align-self-center mx-auto lead"></i>
                        </div>
                    </div>
                    <div class="align-self-center">
                        <h6 class="mb-0">1345</h6>
                        <small class="text-muted">Referidos</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-5 shadow-sm border-0 shadow-hover">
                <div class="card-body d-flex">
                    <div>
                        <div class="circle rounded-circle bg-primary align-self-center d-flex mr-3">
                            <i class="icon ion-md-cash text-primary align-self-center mx-auto lead"></i>
                        </div>
                    </div>
                    <div class="align-self-center">
                        <%=render 'transactions/detectar-moneda', {country: current_user.country}%>
                        <h6 class="mb-0"><%=@moneda_destinity%> <%=number_with_precision(@monto_total_send, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></h6>
                        
                        <small class="text-muted">Enviados a otros paises</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fin highlights -->

    <div class="row mb-3">

        <!-- Tabla de ultimas transacciones -->
        <div class="col-xl-7 col-lg-12">
            <h5>Ultimas Transacciones</h5>
            <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col"><small class="font-weight-bold">Fecha<small></th>
                        <th scope="col"><small class="font-weight-bold">Pais<small></th>
                        <th scope="col"><small class="font-weight-bold">Monto<small></th>
                        <th scope="col"><small class="font-weight-bold">Estado<small></th>
                        
                    </tr>
                </thead>
                <tbody>
                <%@transactions.each do |transaction|%>
                <tr class="shadow-sm">
                    <td><span class="d-block"><%=transaction.created_at.in_time_zone(@zona_horaria).strftime("%d/%m/%Y")%></span><small><%=transaction.created_at.in_time_zone(@zona_horaria).strftime("%H:%M:%S")%></small></td>

                    <td class="align-middle"><img src="/img/paises/<%=transaction.country_destinity%>.svg" class="img-fluid avatar" alt="<%=transaction.country_destinity%>" title="<%=transaction.country_destinity%>"/></td>

                    <%=render 'transactions/detectar-moneda', {country: transaction.country_destinity}%>
                    <td class="align-middle"><span class=""><%=@moneda_destinity%> <%=number_with_precision(transaction.monto_a_recibir, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span></td>

                    <%case transaction.status
                        when "en proceso"
                            badge = "badge-primary"
                        
                        when "por confirmar"
                            badge = "badge-secondary"

                        when "envio en proceso"
                            badge = "badge-info"

                        when "realizada"
                            badge = "badge-success"

                        when "rechazada"
                            badge = "badge-warning"
                        
                        when "presenta incidencia"
                            badge = "badge-warning"
                        
                        when "vencida"
                            badge = "badge-danger"
                    
                    end%>
                    <td class="align-middle"><span class="badge badge-pill <%=badge%>"><%=transaction.status%></span></td>
                </tr>
                <%end%>
                
                </tbody>
            </table>
            <%if @transactions.count === 0%>
                    <div class="alert alert-primary text-center" role="alert">
                        No tienes transacciones registradas!
                    </div>
                <%end%>
            </div>

            <div class="col mt-4">
                <div class="card mb-5 shadow-sm border-0 shadow-hover">
                    <div class="card-header bg-light border-0 pt-3 pb-0">
                        <h6 class="mb-0">Centro de atenci√≥n OC</h6>
                    </div>
                    <div class="card-body">
                        
                        <span>Lunes - Viernes</span><span class="float-right">10:00 - 17:00</span><br><br>
                        <span>Sabados</span><span class="float-right">10:00 - 14:00</span><hr>
                        <i class="fas fa-headphones text-primary" style="font-size:25px"></i><span class="float-right text-primary">+51 9947 8038</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin tabla transacciones -->

        <!-- Mensajes -->
        <div class="col-xl-5 col-lg-12" id="content-notify">
            <div class="card mb-5 shadow-sm border-0 shadow-hover" id="notify">
                <div class="card-header bg-light border-0 pt-3 pb-0">
                    <h6 class="mb-0">Notificaciones</h6>
                </div>
                <div class="card-body">
                    <%@notifications.limit(5).each do |notification|%>
                    <div class="py-3 caja-notf">     
                        <div class="mb-2">
                            <span class="mb-0"><%=notification.emisor%></span>
                            <%segundos = (Time.now - notification.updated_at).to_i
                            if segundos < 120
                                nueva = true
                            else
                                nueva = false 
                            end%>

                            <%if nueva%>
                                <span class="text-white small badge border rounded-pill d-inline-block float-right">Nueva</span>
                            <%end%>
                        </div>
                        <small class="text-muted"><%=notification.asunto%></small><br>
                        <small class="text-muted"><%=notification.content%></small>
                    </div>
                    <%end%>
                    <hr>
                    <div class="text-center text-primary pt-3">
                        <%if @notifications.count > 0%>
                            <!--Button Modal-->
                            <span role="button" style="cursor:pointer;" data-toggle="modal" data-target="#modal-notifications" id="span-modal" onclick="refrescarNotificationsModal()">
                                <small>Ver todas las notificaciones</small>
                            </span>
                        <%else%>
                            <small class="">No tienes notificaciones</small>
                        <%end%>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin mensajes -->

        <!-- Modal de Notificaciones -->
        <div class="modal fade" id="modal-notifications" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" id="content-modal">
                <div class="modal-content" id="content-reload">
                    <div class="modal-header text-center d-inline-block">
                        <h5 class="modal-title" id="staticBackdropLabel">Notificaciones</h5>
                    </div>
                    <div class="modal-body">
                        <%@notifications.each do |notification|%>
                        <div class="py-3 caja-notf">     
                            <div class="mb-2">
                                <span class="mb-0"><%=notification.emisor%></span>
                                <%segundos = (Time.now.utc - notification.updated_at).to_i
                                if segundos < 120
                                    nueva = true
                                else
                                    nueva = false 
                                end%>

                                <%if nueva%>
                                    <span class="text-white small badge border rounded-pill d-inline-block float-right">Nueva</span>
                                <%end%>
                            </div>
                            <small class="text-muted"><%=notification.asunto%></small><br>
                            <small class="text-muted"><%=notification.content%></small>
                        </div>
                        <%end%>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="close-modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        
    </div> 
</section>

<script>
    
    $(document).ready(function(){
        if(typeof refreshNotify === "undefined"){
            refreshNotify = setInterval(refrescarNotifications, 15000);
            $.ajaxSetup({ cache: false });
        }
    });
   
    function refrescarNotifications() {
        $("#content-notify").load(window.location + '?randval='+ Math.random() + " #notify");
    }

    //REFRESCAR LAS NOTIFICACIONES EN EL MODAL
    function refrescarNotificationsModal(){
        $("#content-modal").load(window.location + '?randval='+ Math.random() + " #content-reload");
    }
</script>