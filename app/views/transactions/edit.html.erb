<%=render 'partials/name-and-cod-of-banks'%>
<%unless current_user.is_admin?%>
    <div id="copy" class="">
        <span class="fas fa-check-circle"></span>
        <p class="msg text-justify" id="msj"></p>
    </div>
                
    <div class="row justify-content-center mt-3">
        <div class="col-6 p-3 fondo" style="border-radius:12px;">
            <ul class="nav nav-tabs text-center" id="myTab" role="tablist">
                <li class="nav-item d-inline-block w-50" role="presentation">
                    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Origen</a>
                </li>
                <li class="nav-item d-inline-block w-50" role="presentation">
                    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Destino</a>
                </li>
            </ul>
            <div class="tab-content mt-3" id="myTabContent">
                <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                    <h5>Detalles de la transaccion<span class="float-right h5 <%if @minutos < 5%>text-danger<%else%>text-success<%end%>" id="td-time2"><i class="fas fa-history mr-1"></i><span id="minuto2"><%=@minutos%></span>:<span id="segundo2"><%=@segundos.to_s.rjust(2, '0')%></span></h5>
                    
                    <div class="mt-5">
                        <%#image_tag url_for(@transaction_pendiente.comprobante), style:"width:100%"%>
                        <%@method = @transaction_pendiente.account_destinity_admin.split("-")%>
                        <%= render 'detalle-account-for-copy', {transaction: @transaction_pendiente, user_account: @user_admin, method: @method} %>
                        
                        <%=render 'detectar-moneda', {:country => current_user.country}%>
                        <label class="text-primary">Monto a pagar</label><br>
                        <%=@moneda_destinity%> <span id="monto_pagar"><%= number_with_precision(@transaction_pendiente.monto_envio, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><i class="far fa-copy float-right" onclick="copiarAlPortapapeles('monto_pagar','Monto a pagar')"></i><br><hr>

                        <%= form_with(model: @transaction, local: true, :html => { :class => "was-validated mb-5"}) do |form| %>
                            <% if @transaction.errors.any? %>
                            <div id="error_explanation">
                                <h2><%= pluralize(@transaction.errors.count, "error") %> prohibited this transaction from being saved:</h2>
                            
                                <ul>
                                    <% @transaction.errors.full_messages.each do |message| %>
                                    <li><%= message %></li>
                                    <% end %>
                                </ul>
                            </div>
                            <% end %>
                        
                            <div class="custom-file mb-3">
                                <%=form.file_field :comprobante, class:"custom-file-input is-invalid", id:"validatedCustomFile"%>
                                <label class="custom-file-label" for="validatedCustomFile">Comprobante de pago...</label>
                                <div class="invalid-feedback">Solo puede subir un archivo en formato jpg, jpeg o png</div>
                            </div>

                            <div class="actions mt-4">
                                <%= form.submit "Continuar", class:"btn btn-success m-auto"%>
                                <a type="button" rel="nofollow" data-method="delete" href="/transactions/<%=@transaction.id%>" data-confirm="Esta segur@ de eliminar esta transacción?" class="btn btn-danger float-right">Cancelar transaccion</a>
                            </div>
                        <%end%>
                        
                    </div>
                </div>

                <!--CUENTA DEL USUARIO-->
                <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                    <h5>Detalles del envio</h5>
                    
                    <div class="mt-5">
                        <%@user_account = current_user%>
                        <%@method = @transaction_pendiente.account_destinity_usuario.split("-")%>
                        <%= render 'detalle-account-for-view', {transaction: @transaction_pendiente, user_account: @user_account, method: @method} %>

                        <%=render 'detectar-moneda', {:country => @transaction_pendiente.country_destinity}%>
                        <label class="text-primary">Monto a recibir</label><br>
                        <%=@moneda_destinity%> <span><%= number_with_precision(@transaction_pendiente.monto_a_recibir, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><br><hr>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>

        spanMin2 = document.getElementById("minuto2");
        spanSeg2 = document.getElementById("segundo2");
        tdTime2 = document.getElementById("td-time2");

        function refrescar(){
            window.location.href = window.location.href;
        }

        function restarSegundos2() {
            minutos = spanMin2.innerText;
            segundos = spanSeg2.innerText;
            
            minutos = parseInt(minutos);
            segundos = parseInt(segundos);

            if (minutos <= 0 && segundos <= 0 ){

                clearInterval(intervalo2);
                refrescar();
            }else{
                if (segundos === 0){
                minutos -= 1;
                segundos = 59;
                }else{
                    segundos -= 1;
                }

                if (minutos < 5){
                    tdTime2.classList.remove("text-success");
                    tdTime2.classList.add("text-danger");
                }
                spanMin2.innerHTML = minutos;

                segundos = segundos.toString();
                if (segundos.length === 1){
                    spanSeg2.innerHTML = "0" + segundos;
                }else{
                    spanSeg2.innerHTML = segundos;
                }
            }
            
        }
        
        <%if @transaction_pendiente%>
        if (typeof intervalo2 === "undefined"){
            intervalo2 = setInterval(restarSegundos2, 1000);
        }
        <%end%>
    </script>
<%else%> <!--VISTA DE ADMINISTRADOR ----------------------------------------------------------------------------------------->

    <div id="copy" class="">
        <span class="fas fa-check-circle"></span>
        <p class="msg text-justify" id="msj"></p>
    </div>

    <%if @transaction.status === "por confirmar"%> 

        <div class="row justify-content-center mt-3">
            <div class="col-6 p-3 fondo" style="border-radius:12px;">
                <ul class="nav nav-tabs text-center" id="myTab" role="tablist">
                    <li class="nav-item d-inline-block w-50" role="presentation">
                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Cuenta Crédito Otacar</a>
                    </li>
                    <li class="nav-item d-inline-block w-50" role="presentation">
                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Cuenta Crédito Usuario</a>
                    </li>
                </ul>
                <div class="tab-content mt-4" id="myTabContent">
                    
                    <!--CUENTA DE OTACAR-->
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        
                        <%@user_account = current_user%>
                        <%@method = @transaction.account_destinity_admin.split("-")%>
                        <%= render 'detalle-account-for-view', {transaction: @transaction, user_account: @user_account,method: @method} %>

                        <%=render 'detectar-moneda', {country: @transaction.user.country}%>
                        <label class="text-primary">Monto Transferido</label><br>
                        <%=@moneda_destinity%> <span><%= number_with_precision(@transaction.monto_envio, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><br><hr>

                        <label class="text-primary">Comprobante</label><br>
                        <%=image_tag url_for(@transaction.comprobante), style:"width:100%"%>

                        <%= form_with(model: @transaction, local: true, :html => { :class => "was-validated mb-5"}) do |form| %>
                            <%if @transaction.errors.any?%>
                            <div id="error_explanation">
                                <h2><%= pluralize(@transaction.errors.count, "error") %> prohibited this transaction from being saved:</h2>
                            
                                <ul>
                                    <% @transaction.errors.full_messages.each do |message| %>
                                    <li><%= message %></li>
                                    <% end %>
                                </ul>
                            </div>
                            <%end%>
            
                            <div class="actions mt-4">
                                <%= form.submit "Confirmar", class:"btn btn-success"%>

                                <button type="button" class="btn btn-danger float-right" data-toggle="modal" data-target="#staticBackdrop">
                                    Rechazar transacción
                                </button>

                                <!--MODAL-->
                                <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                
                                            <div class="modal-body text-center">
                                                Estas a punto de rechazar la transacción, especifica el motivo para que lo pueda ver el usuario.
                                                <div class="was-validated">
                                                    <div class="mt-3">
                                                        <label for="validationTextarea" class="text-primary">Motivo *</label>
                                                        <textarea class="form-control is-invalid" id="validationTextarea" name="transaction[motivo_rechazo]"required></textarea>
                                                        <div class="invalid-feedback">
                                                            Especifica el motivo.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="borrarMotivo()">Cerrar</button>
                                                <%= form.submit "Continuar", class:"btn btn-danger"%>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <%end%>
                    </div>

                    <!--CUENTA DEL USUARIO--------------------------------------------------------------------->
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        
                            <%@method = @transaction.account_destinity_usuario.split("-")%>
                            <%= render 'detalle-account-for-view', {transaction: @transaction, user_account: @transaction.user, method: @method} %>
                            
                            <%=render 'detectar-moneda', {country: @transaction.country_destinity}%>
                            <label class="text-primary">Monto a Enviar</label><br>
                            <%=@moneda_destinity%> <span><%= number_with_precision(@transaction.monto_a_recibir, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><br><hr>
                    </div>
                </div> 
            </div>
        </div>
        <script>
            textarea = document.getElementById("validationTextarea");

            function borrarMotivo(){
                textarea.value = "";
            }
        </script>

    <%elsif @transaction.status === "envio en proceso"%>

        <div class="row justify-content-center mt-3">
            <div class="col-6 p-3 fondo" style="border-radius:12px;">
                <ul class="nav nav-tabs text-center" id="myTab" role="tablist">
                    <li class="nav-item d-inline-block w-50" role="presentation">
                        <a class="nav-link active" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Cuenta Crédito Usuario</a>
                    </li>
                    <li class="nav-item d-inline-block w-50" role="presentation">
                        <a class="nav-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Cuenta Crédito Otacar</a>
                    </li>
                </ul>
                <div class="tab-content mt-4" id="myTabContent">
                    
                    <!--CUENTA DEL USUARIO--------------------------------------------------------------------->
                    <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        
                        <%@method = @transaction.account_destinity_usuario.split("-")%>
                        <%= render 'detalle-account-for-copy', {transaction: @transaction, user_account: @transaction.user, method: @method} %>
                        
                        <%=render 'detectar-moneda', {country: @transaction.country_destinity}%>
                        <label class="text-primary">Monto a enviar</label><br>
                        <%=@moneda_destinity%> <span id="monto_a_enviar"><%=number_with_precision(@transaction.monto_a_recibir, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><i class="far fa-copy float-right" onclick="copiarAlPortapapeles('monto_a_enviar','Monto a enviar')"></i><br><hr>

                        <button class="btn btn-copy-all" onclick="copyAll()">Copiar Todo</button>

                        <%= form_with(model: @transaction, local: true, :html => { :class => "was-validated mb-5"}) do |form| %>
                            <%if @transaction.errors.any?%>
                            <div id="error_explanation">
                                <h2><%= pluralize(@transaction.errors.count, "error") %> prohibited this transaction from being saved:</h2>
                            
                                <ul>
                                    <% @transaction.errors.full_messages.each do |message| %>
                                    <li><%= message %></li>
                                    <% end %>
                                </ul>
                            </div>
                            <%end%>
            
                            <div class="actions mt-4">
                                <%= form.submit "Confirmar", class:"btn btn-success"%>
                            </div>
                        <%end%>
                    </div>
                    <!--CUENTA DE OTACAR-->
                    <div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
                        
                        <%@user_account = current_user%>
                        <%@method = @transaction.account_destinity_admin.split("-")%>
                        <%= render 'detalle-account-for-view', {transaction: @transaction, user_account: @user_account, method: @method} %>

                        <%=render 'detectar-moneda', {country: @transaction.user.country}%>
                        <label class="text-primary">Monto Transferido</label><br>
                        <%=@moneda_destinity%> <span><%= number_with_precision(@transaction.monto_envio, :precision => 2, :delimiter => '.', :separator => ',', :scale => 2) %></span><br><hr>

                        <label class="text-primary">Comprobante</label><br>
                        <%=image_tag url_for(@transaction.comprobante), style:"width:100%"%>
                    </div>

                    
                </div> 
            </div>
        </div>
    <%end%>
<%end%>
<script>

    cajaMsj = document.getElementById("copy");
    msjCopy = document.getElementById("msj");
    iconoCopy = document.getElementsByTagName("i");

    function copiarAlPortapapeles(id_elemento,dato) {
        var aux = document.createElement("input");
        aux.setAttribute("value", document.getElementById(id_elemento).innerHTML);
        document.body.appendChild(aux);
        aux.select();
        document.execCommand("copy");
        document.body.removeChild(aux);

        cajaMsj.classList.remove("show","showAlert");
        cajaMsj.classList.add("d-none");

        msjCopy.innerHTML = dato + " copiado";
        cajaMsj.classList.remove("d-none");
        cajaMsj.classList.add("show","showAlert");

        var contador = setTimeout(() => {
            cajaMsj.classList.add("hide");
            cajaMsj.classList.remove("show");
        }, 1000);
        var contador2 = setTimeout(() => {
            cajaMsj.classList.remove("showAlert");
            cajaMsj.classList.remove("hide");
            cajaMsj.classList.add("d-none");
        }, 2000);
    }

    function copyAll(){
        divP = document.getElementById("profile");
        var textarea = document.createElement("textarea");
        var lista = document.createElement("ul");
       
        var spans = document.getElementsByTagName("span");

        for(i=0; i<spans.length; i++){
            if (spans[i].id === "monto_a_enviar"){
                limit = i;
                break;
            }
        }
        for(i=1; i<=limit; i++){ 
           textarea.value = textarea.value + "\\\n" + spans[0].innerText;
        }

        divP.appendChild(textarea);
       
        console.log(textarea.value.length);
        console.log(textarea.value);
        textarea.select();
        //document.execCommand("copy");
        

        cajaMsj.classList.remove("show","showAlert");
        cajaMsj.classList.add("d-none");

        msjCopy.innerHTML = "Informacion copiada";
        cajaMsj.classList.remove("d-none");
        cajaMsj.classList.add("show","showAlert");

        var contador = setTimeout(() => {
            cajaMsj.classList.add("hide");
            cajaMsj.classList.remove("show");
        }, 1000);
        var contador2 = setTimeout(() => {
            cajaMsj.classList.remove("showAlert");
            cajaMsj.classList.remove("hide");
            cajaMsj.classList.add("d-none");
        }, 2000);
        
    }
</script>